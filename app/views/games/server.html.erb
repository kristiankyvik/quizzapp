<style type="text/css">
  
  .hidden{
    display:none;

  }
  body{
    background-image: none;
  }


</style>
<div id="quiz-id" style="display: none;"> <%= @quiz_id %> </div>
<div id="user-id" style="display: none;"> <%= @user_id %> </div>
<div class="container theframe" >
  <div id="scoreboard" class="hidden"></div>
  this is the server that will host the event
  <audio autoplay loop id="audio" ></audio>
  <button class="btn" id="see_scoreboard" >SEE SCOREBOARD</button>
   <div id="quiz-id" style="display: none;"> <%= 1 %> </div>
  <div id = "frame" role = "content" > 
    <div id="players"></div>
    <button class="btn" id="start_game" >START QUIZ</button>
  </div>
</div>

<script src="//js.pusher.com/2.2/pusher.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript">

  var quiztitle ;
  var currentquestion = 0,
      score = 0,
      cansubmit = true,
      quiz,
      picked,
      sheet,
      timer;


  Pusher.log = function(message) {
      if (window.console && window.console.log) {
        window.console.log(message);
      }
    };

    var pusher = new Pusher('0b3fd7d5eb569adb55a2');
    var channel = pusher.subscribe('server_channel');
    channel.bind('new_signup', function(data) {
      $('#players').append('<p>'+ data.message + ' joined the game! </p>');
    });

    channel.bind('update_score', function(data) {
      var scores = data.message;
      $('#scoreboard').empty();
      for ( player_name in scores) {
          $('<p/>').text(player_name + ":" + scores[player_name]).appendTo('#scoreboard');
      }
    });

        $(document).ready(function(){

        function htmlEncode(value) {
            return $(document.createElement('div')).text(value).html();
        }

        var loadAudio = function (link){
          $.ajax({
                  url: "https://api.spotify.com/v1/tracks/"+link,
                  type: 'GET',
                  crossDomain : true,
                  xhrFields: {
              },
                  success: function(data) {
                    audio.setAttribute('src', data.preview_url);
                    audio.play();
                  }
              })
        };

        function setupLayout () {
          $('<h1/>').text(quiztitle).appendTo('#frame');
          $('<button/>').attr('id', 'nextQuest').text("NEXT QUESTION").appendTo('#frame');
          $('<p/>').addClass('questionCounterBanner').attr('id', 'questionCounterBanner').text('Question 1 of ' + quiz.length).appendTo('#frame');
          $('<p/>').addClass('question').attr('id', 'question').text(quiz[0]['question_title']).appendTo('#frame');
          $('<img/>').addClass('question-image').attr('id', 'question-image').attr('src', quiz[0]['image']).attr('alt', htmlEncode(quiz[0]['question'])).appendTo('#frame');
          $('<p/>').addClass('explanation').attr('id', 'explanation').html('&nbsp;').appendTo('#frame');
          $('<ul/>').attr('id', 'choice-block').appendTo('#frame');
          addChoices(quiz[0]['choices']);
          $('<div/>').addClass('choice-box').attr('id', 'nextButton').text('NextQuestion').appendTo('#frame').hide();
          setupButtons();   
        }

        function addChoices(choices) { 
          console.log("currentquestion: " + currentquestion);
          $('#choice-block').empty();
          for (var i = 0; i < choices.length-1; i++) {
            $('<li/>').addClass('choice choice-box').attr('data-index', i).text(choices[i].title).appendTo('#choice-block');
          }
          var steal = $("#choice-block li")[sheet[currentquestion]];
          $(steal).before("<li>" + choices[3].title + "</li>");
        }

        function setupButtons() {
          listenToButtons()
          $('.choice').on('click', function () {
              clearAlert()
              choice = $(this).attr('data-index');
              console.log(choice);
              console.log(currentquestion);
              console.log(quiz[currentquestion]['choices'][choice].title + "sasasa" + quiz[currentquestion]['choices']['correct']);
              if (quiz[currentquestion]['choices'][choice].correct) {
                  $('#explanation').html('<strong>Correct!</strong> ' + htmlEncode(quiz[currentquestion]['explanation']));
                  score++;
              } else {
              $('#explanation').html('<strong>Incorrect.</strong> ' + htmlEncode(quiz[currentquestion]['explanation']));
              }
              $("#nextButton").show();
              if (cansubmit) {
                  cansubmit = false;
                  $("#nextButton").click(function(){
                       $('.choice').off('click');
                      $(this).off('click');
                      upCounter();
                  });
              }
          })
        }



        function listenToButtons(){
          $("#see_scoreboard").on('click', function (){
            $('#scoreboard').removeClass("hidden");
          });

          $("#nextQuest").on('click', function (){
            console.log("clicked next question")

             $.ajax({
                     url: "/games/next_question",
                     type: "post",
                     data: {},
                     dataType: "json"
                   });
            upCounter();
          })

        }

        function showTimeoutBox () {
          $('#myModal').modal({show:true})
          clearAlert();
          $("#next-question-modal").click(function(){
              console.log("clickkkk modall")
              $('.choice').off('click');
              $(this).off('click');
              upCounter();
          });
        }

        function clearAlert() {
          window.clearTimeout(timer);
          console.log("alert cleared!!!");
        }

        function upCounter() {
            currentquestion++;
            $("#nextButton").hide();
                if (currentquestion > quiz.length) {
                    endQuiz();
                } else {     
                    nextQuestion();
                }
        }

        function nextQuestion() {
            cansubmit = true;
            $('#explanation').empty();
            loadAudio(quiz[currentquestion]['song']);
            $('#question').text(quiz[currentquestion]['question']);
            $('#questionCounterBanner').text('Question ' + Number(currentquestion + 1) + ' of ' + quiz.length);  
            $('#question-image').attr('src', quiz[currentquestion]['image']).attr('alt', htmlEncode(quiz[currentquestion]['question']));
            addChoices(quiz[currentquestion]['choices']);
            setupButtons();
            timer = window.setTimeout(showTimeoutBox, 8000)
        }

        function endQuiz() {
            $('#explanation').empty();
            $('#question').empty();
            $('#choice-block').empty();
            $('#nextButton').remove();
            $('#question').text("You got " + score + " out of " + quiz.length + " correct.");
            $('h2').text(Math.round(score / quiz.length * 100) + '%').insertAfter('#question');
        }

        function  createAnswerSheet(){
          lista = [];
          for ( var i = 0; i < quiz.length; i++ ) { 
            lista.push(Math.floor(Math.random() * 3));
          }
          return lista
        };

        function sendAnswerSheet(){
          sheet = createAnswerSheet();
          console.log(sheet);
          var data = {sheet: sheet};
          $.ajax({
                  url: "/games/answersheet",
                  type: "post",
                  data: data,
                  dataType: "json"
                });

        }

          function init() {
            console.log("/users/" + $('#user-id').text() +"/quizzes/" + $('#quiz-id').text() + ".json");
              $.ajax({
                    url: "/users/" + $('#user-id').text() +"/quizzes/" + $('#quiz-id').text() + ".json",
                    type: 'GET',
                    crossDomain : true,
                    xhrFields: {
                    withCredentials: true
                },
                    success: function(data) {
                    }
                }).done(function(data) {
                  quiztitle = Object.keys(data);
                  quiz = data[Object.keys(data)];
                  console.log(quiz)
                  sendAnswerSheet();
                  setupLayout();
                  loadAudio(quiz[0].song);
                  timer = window.setTimeout(showTimeoutBox, 8000);
                });

          }


        $("#start_game").click(function(){
          $.ajax({
              url: "/games/start",
              type: "post",
              data: null,
              dataType: "json"
            });
            console.log($("#frame"));
            $("#frame").html('');
            init();

        });
    });





      



  </script>